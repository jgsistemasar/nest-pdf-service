<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>PROTOCOLO {{protocoloNro}}</title>
    <style>
        @page {
            margin: 15;
        }
        html, body {
            margin: 0;
            padding: 0;
        }
        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 11px;
            color: #000;
            -webkit-print-color-adjust: exact !important;
            page-break-inside: avoid; /* Evitar corte de notas */
            print-color-adjust: exact !important;
            position: relative;
        }
        
        .wm {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
        }
        
        .wm::before {
            content: "";
            position: absolute;
            top: 18%;
            left: 50%;
            width: 70%;
            height: 70%;
            transform: translateX(-50%) rotate(-18deg);
            opacity: 0.20;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
        }
        
        /* Elementos verticales fijos */
        .vertical-left {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 15mm;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: .75;  
        }
        
        .vertical-left-text {
            writing-mode: vertical-lr;
            text-orientation: mixed;
            transform: rotate(180deg);
            font-size: 10px;
            color: #666;
            text-align: center;
            white-space: nowrap;
        }
        
        .vertical-right {
            position: fixed;
            right: 2mm;
            top: 12mm;
            bottom: 12mm;
            width: 20mm;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vertical-right img {
            display: block;
            height: 12mm;
            width: auto;
            transform: rotate(90deg);
            transform-origin: center center;
            image-rendering: -webkit-optimize-contrast;
            position: relative;
            top: -55mm;
            opacity: .35;
        }
        
        /* Contenido principal con márgenes ajustados */
        .main-content {
            margin: 30mm 25mm 35mm 20mm; /* Ajustado para evitar colisión */
            position: relative;
            z-index: 1;
            min-height: calc(100vh - 65mm); /* Asegurar espacio mínimo */
        }
        
        .hdr {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: end;
            margin-bottom: 6mm;
        }
        
        .hdr-title {
            grid-column: 2;
            text-align: center;
            font-weight: 700;
            text-decoration: underline;
            font-size: 20px;
        }
        
        .hdr-meta {
            grid-column: 3;
            font-size: 14px;
            white-space: nowrap;
            justify-self: end;
        }
        
        .fields {
            margin-top: 2mm;
            margin-bottom: 4mm;
            border-bottom: 1px solid #000;
            padding-bottom: 2mm;
        }
        
        .row {
            display: grid;
            grid-template-columns: 32mm 1fr;
            column-gap: 4mm;
            align-items: baseline;
            line-height: 1.25;
            margin-bottom: 1.5mm;
        }
        
        .lbl {
            font-weight: 700;
        }
        
        .val {
            word-break: break-word;
            overflow-wrap: anywhere;
        }
        
        .fields-2 {
            margin-top: 4mm;
            margin-bottom: 6mm;
        }
        
        .row-2 {
            display: grid;
            grid-template-columns: 32mm 1fr;
            column-gap: 4mm;
            align-items: baseline;
            line-height: 1.25;
            margin-bottom: 1.5mm;
        }
        
        .assay-title {
            font-weight: 700;
            margin: 2mm 0 1mm 0;
        }
        
        .assay-desc {
            margin-bottom: 2mm;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            page-break-inside: auto;
        }
        
        thead th {
            border: none solid #000;
            padding: 2.5mm 2mm;
            text-align: center;
            font-weight: 700;
            background: #f0ca6b;
            color: #000;
        }
        
        tbody td {
            border: none solid #000;
            padding: 2.5mm 2mm;
            text-align: center;
            vertical-align: middle;
        }
        
        .left {
            text-align: left;
        }
        
        .notes {
            margin-top: 6mm;
            margin-bottom: 10mm; /* Espacio extra antes del footer */
        }
        
        .note {
            margin-bottom: 2.5mm;
            text-align: justify;
            page-break-inside: avoid; /* Evitar corte de notas */
        }

        /* Espaciador para evitar colisión con footer */
        .footer-spacer {
            height: 15mm;
        }
    </style>
    {{#if firmado}}
    <style>
        .wm::before {
            background-image: url('{{asset "tilde-mostaza-solo.png"}}');
        }
    </style>
    {{/if}}
</head>
<body {{#if firmado}}class="wm"{{/if}}>
    <!-- Elementos verticales fijos -->
    <div class="vertical-left">
        <div class="vertical-left-text">
            <div>Ninguna parte de este documento puede ser reproducida, de ninguna forma o por ningún medio, sin previa autorización escrita de JLA</div>        
            <div>No part of this certificate can be reproduced in any form or by any means, whithout permission in written from JLA.</div>
        </div>
    </div>
    
    <div class="vertical-right">
        <img src="{{asset 'senasa.png'}}" alt="SENASA">
    </div>

    <!-- Contenido principal -->
    <div class="main-content">
        <div class="hdr">
            <div></div>
            <div class="hdr-title">PROTOCOLO</div>
            <div class="hdr-meta">Protocolo Nro: {{protocoloNro}}</div>
        </div>

        <div class="fields">
            <div class="row"><div class="lbl">Sr./es de:</div><div class="val">{{srDe}}</div></div>
            <div class="row"><div class="lbl">Domicilio:</div><div class="val">{{domicilio}}</div></div>
            <div class="row"><div class="lbl">Atención:</div><div class="val">{{atencion}}</div></div>
            <div class="row"><div class="lbl">De:</div><div class="val">{{de}}</div></div>
            <div class="row"><div class="lbl">Fecha de emisión:</div><div class="val">{{formatDate fechaEmision}}</div></div>
        </div>

        {{#if dsProtocoloLotes}}
        {{#each dsProtocoloLotes}}
        <div class="fields-2">
            <div class="row-2"><div class="lbl">{{this.cantidadEnvaseLabel}}</div><div class="val">{{this.cantidadEnvaseValue}}</div></div>
            <div class="row-2"><div class="lbl">{{this.productoLabel}}</div><div class="val">{{this.productoValue}}</div></div>
            <div class="row-2"><div class="lbl">{{this.lugarDeProcesadoLabel}}</div><div class="val">{{this.lugarDeProcesadoValue}}</div></div>
            <div class="row-2"><div class="lbl">{{this.muestralabel}}</div><div class="val">{{this.muestraValue}}</div></div>
            <div class="row-2"><div class="lbl">{{this.fechaMuestreoLabel}}</div><div class="val">{{this.fechaMuestreoValue}}</div></div>
        </div>
        {{/each}}
        {{/if}}

        <div class="notes">
            {{#if dsProtocoloNotasPreDetalle}}
            {{#each dsProtocoloNotasPreDetalle}}
            {{#if textoES}}<div class="note">{{textoES}}</div>{{/if}}
            {{/each}}
            {{/if}}
        </div>

        {{#if dsProtocoloLotesDetalleAFLA}}
        {{#with (lookup dsProtocoloLotesDetalleAFLA 0) as |afla0|}}
        {{#if afla0.descripcion}}<div class="assay-title">{{afla0.descripcion}}</div>{{/if}}
        {{#if afla0.adicional}}<div class="assay-desc">{{afla0.adicional}}</div>{{/if}}
        {{/with}}
        {{/if}}

        <div class="avoid-break">
            <table>
                <thead>
                    <tr>
                        <th class="left">Lote</th>
                        <th>Fecha de análisis</th>
                        <th>Fracción</th>
                        <th>G2</th>
                        <th>G1</th>
                        <th>B2</th>
                        <th>B1</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {{#if dsProtocoloLotes}}
                    {{#with (lookup dsProtocoloLotes 0) as |firstLot|}}
                    {{#if ../dsProtocoloLotesDetalleAFLA.length}}
                    {{#each ../dsProtocoloLotesDetalleAFLA}}
                    <tr {{#unless @first}}style="border-top:1px solid #000"{{/unless}}>
                        {{#if @first}}
                        <td class="left" rowspan="{{../../dsProtocoloLotesDetalleAFLA.length}}" style="background:#fdecc8">
                            {{#if firstLot.loteValue}}{{firstLot.loteValue}}{{else}}—{{/if}}
                        </td>
                        <td rowspan="{{../../dsProtocoloLotesDetalleAFLA.length}}">
                            {{#if firstLot.fechaAnalisisValue}}{{firstLot.fechaAnalisisValue}}{{/if}}
                        </td>
                        {{/if}}
                        <td>{{fraccion}}</td>
                        <td>{{aflaG2}}</td>
                        <td>{{aflaG1}}</td>
                        <td>{{aflaB2}}</td>
                        <td>{{aflaB1}}</td>
                        <td>{{aflaTotal}}</td>
                    </tr>
                    {{/each}}
                    {{/if}}
                    {{/with}}
                    {{/if}}
                </tbody>
            </table>
        </div>

        <div class="notes">
            {{#if dsProtocoloNotas}}
            {{#each dsProtocoloNotas}}
            {{#if textoES}}<div class="note">{{textoES}}</div>{{/if}}
            {{/each}}
            {{/if}}
        </div>

        <!-- Espaciador para evitar colisión con footer -->
        <div class="footer-spacer"></div>
    </div>
</body>
</html>