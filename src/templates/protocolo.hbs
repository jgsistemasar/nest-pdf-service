<!doctype html> 
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>PROTOCOLO {{protocoloNro}}</title>
  <style>
    /* Página y tipografía */
    @page { margin: 15mm 12mm 28mm 12mm; }
    html, body { margin:0; padding:0; }
    body {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 12px;
      color:#000;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }

    /* ===== CABECERA ===== */
    .masthead {
      display: grid;
      grid-template-columns: 1fr auto 1fr auto 4px;
      align-items: center;
      column-gap: 8mm;
      margin: 6mm 0 4mm 0;
    }
    .mh-line { height: 2px; background:#6f6f6f; }
    .mh-logo { width: 36mm; height: 20mm; display:flex; align-items:center; justify-content:center; }
    .mh-logo img { max-height:20mm; max-width:36mm; object-fit:contain; }
    .mh-contact { text-align: right; line-height: 1.25; font-size: 12px; color:#000; white-space: nowrap; padding-right: 3mm; }
    .mh-bar { width:4px; height:22mm; background:#781719; }

    /* ===== Título + nro a la derecha ===== */
    .hdr { display:grid; grid-template-columns: 1fr auto; align-items:end; margin-bottom: 6mm; }
    .hdr-title { text-align:center; font-weight:700; text-decoration:underline; font-size:20px; }
    .hdr-meta { font-size:12px; white-space:nowrap; }

    /* ===== Campos en columna ===== */
    .fields { margin-top:2mm; margin-bottom:4mm; border-bottom:1px solid #000; padding-bottom:2mm; }
    .row { display:grid; grid-template-columns: 32mm 1fr; column-gap:4mm; align-items:baseline; line-height:1.25; margin-bottom:1.5mm; }
    .lbl { font-weight:700; }
    .val { word-break: break-word; overflow-wrap:anywhere; }

    .fields-2 { margin-top:4mm; margin-bottom:6mm; }
    .row-2 { display:grid; grid-template-columns:32mm 1fr; column-gap:4mm; align-items:baseline; line-height:1.25; margin-bottom:1.5mm; }

    /* ===== Texto de método ===== */
    .assay-title { font-weight:700; margin: 2mm 0 1mm 0; }
    .assay-desc  { margin-bottom: 2mm; }

    /* ===== Tabla ===== */
    table { width:100%; border-collapse:collapse; font-size:12px; }
    thead th { border:1px solid #000; padding:2.5mm 2mm; text-align:center; font-weight:700; background:#fff; color:#000; }
    tbody td { border:1px solid #000; padding:2.5mm 2mm; text-align:center; vertical-align:middle; }
    .left { text-align:left; }

    /* ===== Notas debajo de la grilla ===== */
    .notes { margin-top: 6mm; }
    .note  { margin-bottom: 2.5mm; text-align: justify; white-space: pre-wrap; }

    /* ===== Espaciador para pie ===== */
    .footer-spacer { height: 34mm; }

    /* ===== PIE ===== */
    .footer-fixed { position: fixed; left:0; right:0; bottom:10mm; z-index:10; color:#000; }
    .foot-top { display:grid; grid-template-columns: 6mm 1fr; align-items:center; column-gap: 4mm; margin-bottom: 2mm; }
    .foot-bar  { width:6mm; height:16px; background:#781719; }
    .foot-line { height:1px; background:#6f6f6f; }

    .foot-text   { font-size:12px; line-height:1.35; }
    .foot-strong { font-weight:700; }
    .foot-center { text-align:center; margin-top: 2mm; }
    .foot-dup    { font-weight:700; text-transform:uppercase; text-align:center; margin-top: 3mm; }
    .page-num    { text-align:center; margin-top: 3mm; font-size:12px; }
  </style>
</head>
<body>

  <!-- CABECERA -->
  <div class="masthead">
    <div class="mh-line"></div>
    <div class="mh-logo"><img src="icon-512x512.png" alt="Logo"></div>
    <div class="mh-line"></div>
    <div class="mh-contact">
      <div>www.jla.com.ar</div>
      <div>info@jla.com.ar</div>
      <div>Bv. Italia N° 1150</div>
      <div>(X5809BAS) General Cabrera - Córdoba - Argentina</div>
      <div>Tel. 54 358 4931340 / Fax 54 358 4931271</div>
    </div>
    <div class="mh-bar"></div>
  </div>

  <!-- Título + nro -->
  <div class="hdr">
    <div class="hdr-title">PROTOCOLO</div>
    <div class="hdr-meta">Protocolo Nro: {{protocoloNro}}</div>
  </div>

  <!-- Campos -->
  <div class="fields">
    <div class="row"><div class="lbl">Sr./es de:</div><div class="val">{{srDe}}</div></div>
    <div class="row"><div class="lbl">Domicilio:</div><div class="val">{{domicilio}}</div></div>
    <div class="row"><div class="lbl">Atención:</div><div class="val">{{atencion}}</div></div>
    <div class="row"><div class="lbl">De:</div><div class="val">{{de}}</div></div>
    <div class="row"><div class="lbl">Fecha de emisión:</div><div class="val">{{formatDate fechaEmision}}</div></div>
  </div>

{{#if dsProtocoloLotes}}
  {{#each dsProtocoloLotes}}
    <div class="fields-2">
      <div class="row-2"><div class="lbl">{{this.cantidadEnvaseLabel}}</div><div class="val">{{this.cantidadEnvaseValue}}</div></div>
      <div class="row-2"><div class="lbl">{{this.productoLabel}}</div><div class="val">{{this.productoValue}}</div></div>
      <div class="row-2"><div class="lbl">{{this.lugarDeProcesadoLabel}}</div><div class="val">{{this.lugarDeProcesadoValue}}</div></div>
      <div class="row-2"><div class="lbl">{{this.muestralabel}}</div><div class="val">{{this.muestraValue}}</div></div>
      <div class="row-2"><div class="lbl">{{this.fechaMuestreoLabel}}</div><div class="val">{{formatDate this.fechaMuestreoValue}}</div></div>
    </div>
  {{/each}}
{{/if}}

  {{!-- Notas pre-detalle si se las quiere arriba (opcional) --}}
  {{#if dsProtocoloNotasPreDetalle}}
    {{#each dsProtocoloNotasPreDetalle}}
      {{#if textoES}}<div class="note">{{textoES}}</div>{{/if}}
    {{/each}}
  {{/if}}

  {{#if dsProtocoloLotesDetalleAFLA}}
      {{#each dsProtocoloLotesDetalleAFLA}}
        <div class="assay-title">{{this.descripcion}}</div>
        <div class="assay-desc">{{this.adicional}}</div>
      {{/each}}
  {{/if}}

  <!-- Tabla (se deja tal cual tu lógica) -->
  <table>
    <thead>
      <tr>
        {{#if dsProtocoloLotes}}
        {{#each dsProtocoloLotes}}
        <th class="left">{{this.loteLabel}}</th>
        <th>{{this.fechaAnalisisLabel}}</th>
        {{/each}}
        {{/if}}
        <th>Fracción</th>
        {{#if columnas}}
          {{#each columnas}}<th>{{this}}</th>{{/each}}
        {{else}}
          {{#each plantilla}}<th>{{this.nombre}}</th>{{/each}}
        {{/if}}
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      {{#if resultados}}
        {{#each resultados}}
          <tr>
            <td class="left">{{../lote}}</td>
            <td>{{formatDate ../fechaAnalisis}}</td>
            <td>{{fraccion}}</td>
            {{#if valores}}
              {{#each valores}}<td>{{this}}</td>{{/each}}
            {{else}}
              {{#each ../columnas}}<td>{{lookup ../this this}}</td>{{/each}}
            {{/if}}
            <td>{{total}}</td>
          </tr>
        {{/each}}
      {{else}}
        <tr>
          <td class="left">{{lote}}</td>
          <td>{{formatDate fechaAnalisis}}</td>
          <td>{{fraccion}}</td>
          {{#each plantilla}}<td>{{this.valor}}</td>{{/each}}
          <td>{{total}}</td>
        </tr>
      {{/if}}
    </tbody>
  </table>

  <!-- ===== NOTAS (debajo de la grilla) ===== -->
  <div class="notes">
    {{#if dsProtocoloNotas}}
      {{#each dsProtocoloNotas}}
        {{#if textoES}}<div class="note">{{textoES}}</div>{{/if}}
      {{/each}}
    {{/if}}
  </div>

  <div class="footer-spacer"></div>

  <!-- PIE -->
  <div class="footer-fixed">
    <div class="foot-top">
      <div class="foot-bar"></div>
      <div class="foot-line"></div>
    </div>

    <div class="foot-text">
      <span class="foot-strong">
        LABORATORIO N°:
        {{!-- usa plano si viene, si no toma dsProtocolo[0].codigoTipoLaboratorio --}}
        {{#if codigoTipoLaboratorio}}
          {{codigoTipoLaboratorio}}
        {{else}}
          {{#if dsProtocolo}}
            {{#with (lookup dsProtocolo 0)}}
              {{codigoTipoLaboratorio}}
            {{/with}}
          {{/if}}
        {{/if}}
      </span><br/>
      El laboratorio se compromete a remitir resultados, en el presente, únicamente en acciones específicas, para las cuales se encuentre
      AUTORIZADO por la RED NACIONAL DE LABORATORIOS y a solo efecto de ser presentado ante el SENASA.
    </div>

    <div class="foot-center">
      <div class="foot-strong">COPIA INFORMATIVA</div>
      <div>Este reporte se emite únicamente para ser presentado por el exportador ante las autoridades de</div>
      <div>SENASA en cumplimiento de la resolución 436/02</div>
    </div>

    {{!-- DUPLICADO: usa plano o dsProtocolo[0].duplicado --}}
    {{#if duplicado}}
      <div class="foot-dup">DUPLICADO</div>
    {{else}}
      {{#if dsProtocolo}}
        {{#with (lookup dsProtocolo 0)}}
          {{#if duplicado}}<div class="foot-dup">DUPLICADO</div>{{/if}}
        {{/with}}
      {{/if}}
    {{/if}}

    <div class="page-num">Página <span class="pageNumber">1</span> de <span class="totalPages">1</span></div>
  </div>

</body>
</html>
